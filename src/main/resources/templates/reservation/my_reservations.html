<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ë‚´ ì˜ˆì•½ ì •ë³´</title>
    <link rel="stylesheet" th:href="@{/css/bottom.css}">
    <link rel="stylesheet" th:href="@{/css/top.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        /* ë©”ì¸ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
        .my-reservations-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        /* í˜ì´ì§€ ì œëª© ìŠ¤íƒ€ì¼ */
        .page-title {
            font-size: 2rem;
            margin-bottom: 2rem;
            color: #333;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 1rem;
        }

        /* í•„í„° ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
        .filter-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: 8px;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-label {
            font-weight: 600;
            color: #555;
        }

        .search-box {
            padding: 0.5rem 1rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 200px;
        }

        .filter-select {
            padding: 0.5rem 1rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
        }

        /* ì˜ˆì•½ ì—†ìŒ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
        .no-reservations {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
            background-color: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 2rem;
        }

        .no-reservations i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #adb5bd;
        }

        .no-reservations h3 {
            margin-bottom: 0.5rem;
            color: #495057;
        }

        /* ì˜ˆì•½ ì¹´ë“œ ìŠ¤íƒ€ì¼ - ì„¸ë¡œ í¬ê¸° ì¤„ì„ */
        .reservations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 1.2rem;
        }

        .reservation-card {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .reservation-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }

        .reservation-header {
            padding: 0.7rem 1rem;
            background-color: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .reservation-title {
            font-size: 1.2rem;
            margin: 0;
            color: #343a40;
        }

        .business-name {
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 0.25rem;
        }

        .reservation-content {
            padding: 0.8rem 1rem;
        }

        .reservation-details {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 0.4rem 1rem;
            margin-bottom: 0.8rem;
        }

        .detail-label {
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
        }

        .detail-value {
            color: #212529;
            font-size: 0.9rem;
        }

        .reservation-status {
            display: inline-block;
            padding: 0.2rem 0.6rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-top: 0.4rem;
        }

        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }

        .status-confirmed {
            background-color: #d1e7dd;
            color: #0f5132;
        }

        .status-cancelled {
            background-color: #f8d7da;
            color: #842029;
        }

        .status-completed {
            background-color: #cfe2ff;
            color: #084298;
        }

        .reservation-footer {
            display: flex;
            justify-content: space-between;
            padding: 0.7rem 1rem;
            background-color: #f8f9fa;
            border-top: 1px solid #e9ecef;
        }

        .btn {
            padding: 0.4rem 0.9rem;
            border: none;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .btn-cancel {
            background-color: #dc3545;
            color: white;
        }

        .btn-cancel:hover {
            background-color: #c82333;
        }

        .btn-view {
            background-color: #0d6efd;
            color: white;
        }

        .btn-view:hover {
            background-color: #0b5ed7;
        }

        .btn-disabled {
            background-color: #6c757d;
            color: white;
            cursor: not-allowed;
        }

        /* í˜ì´ì§€ë„¤ì´ì…˜ ìŠ¤íƒ€ì¼ */
        .pagination-container {
            display: flex;
            justify-content: center;
            margin-top: 2rem;
        }

        .pagination {
            display: flex;
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .page-item {
            margin: 0 0.25rem;
        }

        .page-link {
            display: block;
            padding: 0.5rem 0.75rem;
            color: #0d6efd;
            background-color: #fff;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            text-decoration: none;
            transition: background-color 0.3s;
            cursor: pointer;
        }

        .page-link:hover {
            background-color: #e9ecef;
        }

        .page-item.active .page-link {
            background-color: #0d6efd;
            color: white;
            border-color: #0d6efd;
        }

        .page-item.disabled .page-link {
            color: #6c757d;
            pointer-events: none;
            cursor: not-allowed;
            background-color: #fff;
            border-color: #dee2e6;
        }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal {
            background-color: white;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            padding: 1rem;
            background-color: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.25rem;
            margin: 0;
            color: #343a40;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6c757d;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1rem;
            background-color: #f8f9fa;
            border-top: 1px solid #e9ecef;
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        /* ë°˜ì‘í˜• ìŠ¤íƒ€ì¼ */
        @media (max-width: 768px) {
            .filter-section {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }

            .reservations-grid {
                grid-template-columns: 1fr;
            }

            .modal {
                width: 95%;
            }
        }
    </style>
</head>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const hasReloaded = sessionStorage.getItem("hasReloadedOnce");

        // ìë™ ìƒíƒœ ë³€ê²½ ì´í›„ 1ì´ˆ ë’¤ ìƒˆë¡œê³ ì¹¨
        if (!hasReloaded) {
            sessionStorage.setItem("hasReloadedOnce", "true");
            setTimeout(() => location.reload(), 100); // ğŸ” 0.1ì´ˆ ë’¤ ìƒˆë¡œê³ ì¹¨
        } else {
            sessionStorage.removeItem("hasReloadedOnce");
        }
    });
</script>

<body>
<!-- ìƒë‹¨ ë©”ë‰´ include -->
<div th:replace="~{include/top_search :: top_search}"></div>

<div class="my-reservations-container">
    <h1 class="page-title">ë‚´ ì˜ˆì•½ ì •ë³´</h1>

    <!-- í•„í„° ì„¹ì…˜ -->
    <div class="filter-section">
        <div class="filter-group">
            <span class="filter-label">ìƒíƒœ:</span>
            <select id="statusFilter" class="filter-select">
                <option value="all">ì „ì²´</option>
                <option value="PENDING">ëŒ€ê¸°ì¤‘</option>
                <option value="CONFIRMED">í™•ì •ë¨</option>
                <option value="CANCELLED">ì·¨ì†Œë¨</option>
                <option value="COMPLETED">ì™„ë£Œë¨</option>
            </select>
        </div>
        <div class="filter-group">
            <span class="filter-label">ì •ë ¬:</span>
            <select id="sortFilter" class="filter-select">
                <option value="date_desc">ë‚ ì§œ (ìµœê·¼ìˆœ)</option>
                <option value="date_asc">ë‚ ì§œ (ì˜¤ë˜ëœìˆœ)</option>
                <option value="price_desc">ê°€ê²© (ë†’ì€ìˆœ)</option>
                <option value="price_asc">ê°€ê²© (ë‚®ì€ìˆœ)</option>
            </select>
        </div>
        <div class="filter-group">
            <input type="text" id="searchBox" class="search-box" placeholder="ì•„ì´í…œ ì´ë¦„ ê²€ìƒ‰...">
        </div>
    </div>

    <!-- ì˜ˆì•½ ì—†ìŒ ë©”ì‹œì§€ (ì˜ˆì•½ì´ ì—†ì„ ë•Œë§Œ í‘œì‹œ) -->
    <div class="no-reservations" th:if="${#lists.isEmpty(reservations)}">
        <i class="fas fa-calendar-times"></i>
        <h3>ì˜ˆì•½ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</h3>
        <p>ìƒˆë¡œìš´ ì˜ˆì•½ì„ ë“±ë¡í•˜ì‹œë©´ ì´ê³³ì—ì„œ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        <a th:href="@{/}" class="btn btn-view">ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
    </div>

    <!-- ì˜ˆì•½ ëª©ë¡ -->
    <div class="reservations-grid" th:if="${not #lists.isEmpty(reservations)}">
        <!-- ì˜ˆì•½ ì¹´ë“œ ë°˜ë³µ - í´ëŸ½ IDê°€ nullì´ ì•„ë‹Œ ê²½ìš° ìˆ¨ê¹€ -->
        <div class="reservation-card"
             th:each="reservation : ${reservations}"
             th:data-reservation-id="${reservation.reservation_id}"
             th:data-page="1"
             th:data-club-id="${reservation.club_id}"
             th:style="${reservation.club_id != null && reservation.club_id > 0} ? 'display: none;' : ''">
            <div class="reservation-header">
                <h3 class="reservation-title" th:text="${reservation.item_title}">ì•„ì´í…œ ì œëª©</h3>
            </div>
            <div class="reservation-content">
                <div class="reservation-details">
                    <div class="detail-label">ì˜ˆì•½ ë‚ ì§œ:</div>
                    <div class="detail-value" th:text="${#dates.format(reservation.reservation_date, 'yyyyë…„ MMì›” ddì¼')}">2023ë…„ 07ì›” 15ì¼</div>

                    <div class="detail-label">ì˜ˆì•½ ì‹œê°„:</div>
                    <div class="detail-value" th:text="${reservation.start_time} + ':00 ~ ' + ${reservation.end_time} + ':00'">10:00 ~ 12:00</div>

                    <div class="detail-label">ì˜ˆì•½ ê¸ˆì•¡:</div>
                    <div class="detail-value" th:text="${#numbers.formatInteger(reservation.total_price, 0, 'COMMA') + 'ì›'}">20,000ì›</div>

                    <div class="detail-label">ì˜ˆì•½ ìƒíƒœ:</div>
                    <div class="detail-value">
                <span
                        class="status-badge"
                        th:with="status=${reservation.status}"
                        th:classappend="${status == 'PENDING' ? 'status-pending' :
                                        (status == 'CONFIRMED' ? 'status-confirmed' :
                                        (status == 'CANCELLED' ? 'status-cancelled' :
                                        (status == 'COMPLETED' ? 'status-completed' : '')))}"
                        th:data-status="${status}"
                        th:text="${status == 'PENDING' ? 'ëŒ€ê¸°ì¤‘' :
                                 (status == 'CONFIRMED' ? 'ì˜ˆì•½ì™„ë£Œ' :
                                 (status == 'CANCELLED' ? 'ì·¨ì†Œë¨' :
                                 (status == 'COMPLETED' ? 'ì´ìš©ì™„ë£Œ' : 'ì•Œ ìˆ˜ ì—†ìŒ')))}">
                ìƒíƒœ
                </span>
                    </div>
                </div>
            </div>
            <div class="reservation-footer">
                <button
                        th:if="${reservation.status == 'PENDING'}"
                        th:onclick="'openCancelModal(' + ${reservation.reservation_id} + ')'"
                        class="btn btn-cancel">
                    ì˜ˆì•½ ì·¨ì†Œ
                </button>
                <button
                        th:if="${reservation.status != 'PENDING'}"
                        class="btn btn-disabled" disabled>
                    ì˜ˆì•½ ì·¨ì†Œ
                </button>


                <!-- âœ… ë¦¬ë·° ë‚¨ê¸°ê¸° ë²„íŠ¼ ë˜ëŠ” ì™„ë£Œëœ ë²„íŠ¼ ì¡°ê±´ ë¶„ê¸° -->
                <a th:if="${reservation.status == 'COMPLETED' and !reviewExistsMap[reservation.reservation_id]}"
                   th:href="@{/reservation/write_review(reservation_id=${reservation.reservation_id})}"
                   class="btn btn-secondary">
                    ë¦¬ë·° ë‚¨ê¸°ê¸°
                </a>
                <button th:if="${reservation.status == 'COMPLETED' and reviewExistsMap[reservation.reservation_id]}"
                        class="btn btn-disabled" disabled>
                    ë¦¬ë·° ì™„ë£Œ
                </button>


                <a
                        th:href="@{/reservation/confirmation(reservation_id=${reservation.reservation_id})}"
                        class="btn btn-view">
                    ìƒì„¸ ë³´ê¸°
                </a>
            </div>
        </div>
    </div>

    <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
    <div class="pagination-container" th:if="${not #lists.isEmpty(reservations)}">
        <ul class="pagination" id="pagination">
            <li class="page-item disabled" id="prev-page">
                <a class="page-link" href="#">ì´ì „</a>
            </li>
            <!-- í˜ì´ì§€ ë²ˆí˜¸ëŠ” JavaScriptì—ì„œ ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤. ì´ˆê¸° í˜ì´ì§€ ë²ˆí˜¸ëŠ” ì§€ìš°ê³  ìŠ¤í¬ë¦½íŠ¸ë¡œ ìƒì„± -->
            <li class="page-item disabled" id="next-page">
                <a class="page-link" href="#">ë‹¤ìŒ</a>
            </li>
        </ul>
    </div>
</div>

<!-- ì·¨ì†Œ í™•ì¸ ëª¨ë‹¬ -->
<div class="modal-backdrop" id="cancelModal">
    <div class="modal">
        <div class="modal-header">
            <h4 class="modal-title">ì˜ˆì•½ ì·¨ì†Œ í™•ì¸</h4>
            <button type="button" class="close-modal" onclick="closeCancelModal()">&times;</button>
        </div>
        <div class="modal-body">
            <p>ì •ë§ë¡œ ì´ ì˜ˆì•½ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
            <p>ì·¨ì†Œ í›„ì—ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeCancelModal()">ì·¨ì†Œ</button>
            <form id="cancelForm" th:action="@{/reservation/cancel}" method="post">
                <input type="hidden" id="reservationIdToCancel" name="reservation_id">
                <button type="submit" class="btn btn-danger">ì˜ˆì•½ ì·¨ì†Œí•˜ê¸°</button>
            </form>
        </div>
    </div>
</div>

<!-- í•˜ë‹¨ ì •ë³´ë°” -->
<div th:replace="~{include/bottom_info :: bottom_info}"></div>

<script th:src="@{/js/top.js}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // í˜ì´ì§€ë„¤ì´ì…˜ ë³€ìˆ˜ ì„¤ì •
        const itemsPerPage = 5;
        let currentPage = 1;
        let filteredCards = [];

        // í•„í„°ë§ ê¸°ëŠ¥
        const statusFilter = document.getElementById('statusFilter');
        const sortFilter = document.getElementById('sortFilter');
        const searchBox = document.getElementById('searchBox');
        const reservationCards = document.querySelectorAll('.reservation-card');
        const paginationContainer = document.querySelector('.pagination-container');
        const paginationElement = document.getElementById('pagination');
        const prevPageBtn = document.getElementById('prev-page');
        const nextPageBtn = document.getElementById('next-page');

        // ë‚ ì§œê°€ ì§€ë‚œ ì˜ˆì•½ì˜ ìƒíƒœë¥¼ ìë™ìœ¼ë¡œ ë³€ê²½í•˜ëŠ” í•¨ìˆ˜
        // ë‚ ì§œê°€ ì§€ë‚œ ì˜ˆì•½ì˜ ìƒíƒœë¥¼ ìë™ìœ¼ë¡œ ë³€ê²½í•˜ëŠ” í•¨ìˆ˜
        function updateCompletedReservations() {
            const today = new Date();

            reservationCards.forEach(card => {
                const statusElement = card.querySelector('.status-badge');
                if (!statusElement) return;

                const status = statusElement.getAttribute('data-status');
                if (status !== 'PENDING' && status !== 'CONFIRMED') return;

                const dateElement = card.querySelectorAll('.detail-value')[0];
                const timeElement = card.querySelectorAll('.detail-value')[1];
                if (!dateElement || !timeElement) return;

                const dateText = dateElement.textContent.trim();
                const timeText = timeElement.textContent.trim();

                const dateParts = dateText.match(/(\d{4})ë…„\s*(\d{1,2})ì›”\s*(\d{1,2})ì¼/);
                const timeParts = timeText.match(/(\d{1,2}):00\s*~\s*(\d{1,2}):00/);
                if (!dateParts || !timeParts) return;

                const year = parseInt(dateParts[1]);
                const month = parseInt(dateParts[2]) - 1;
                const day = parseInt(dateParts[3]);
                const endHour = parseInt(timeParts[2]);

                const reservationEndTime = new Date(year, month, day, endHour, 0, 0);
                const reservationId = card.getAttribute('data-reservation-id');
                if (!reservationId) return;

                if (today > reservationEndTime) {
                    if (status === 'PENDING') {
                        console.log(`â›” ìë™ ì·¨ì†Œ ì²˜ë¦¬: ì˜ˆì•½ ID = ${reservationId}`);

                        // ì„œë²„ì— ì·¨ì†Œ ìš”ì²­ (í™˜ë¶ˆ í¬í•¨)
                        fetch('/reservation/cancel', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: `reservation_id=${reservationId}`
                        }).then(res => {
                            if (res.ok) {
                                statusElement.textContent = 'ì·¨ì†Œë¨';
                                statusElement.className = 'status-badge status-cancelled';
                                statusElement.setAttribute('data-status', 'CANCELLED');

                                const cancelBtn = card.querySelector('.btn-cancel');
                                if (cancelBtn) {
                                    const disabledBtn = document.createElement('button');
                                    disabledBtn.className = 'btn btn-disabled';
                                    disabledBtn.disabled = true;
                                    disabledBtn.textContent = 'ì˜ˆì•½ ì·¨ì†Œ';
                                    cancelBtn.parentNode.replaceChild(disabledBtn, cancelBtn);
                                }
                            } else {
                                console.error('âŒ ìë™ ì·¨ì†Œ ì‹¤íŒ¨:', res.status);
                            }
                        });

                    } else if (status === 'CONFIRMED') {
                        console.log(`âœ… ìë™ ì™„ë£Œ ì²˜ë¦¬: ì˜ˆì•½ ID = ${reservationId}`);

                        statusElement.textContent = 'ì™„ë£Œë¨';
                        statusElement.className = 'status-badge status-completed';
                        statusElement.setAttribute('data-status', 'COMPLETED');

                        fetch('/reservation/update-status', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: `reservation_id=${reservationId}&status=COMPLETED`
                        }).catch(err => {
                            console.error('âŒ ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', err);
                        });
                    }
                }
            });
        }







        // í´ëŸ½ IDê°€ ìˆëŠ” ì˜ˆì•½ì„ í•„í„°ë§í•˜ëŠ” í•¨ìˆ˜
        function hideClubReservations() {
            reservationCards.forEach(card => {
                const clubId = card.getAttribute('data-club-id');
                // clubIdê°€ nullì´ ì•„ë‹ˆê³  0ë³´ë‹¤ í¬ë©´ (í´ëŸ½ ì˜ˆì•½ì´ë©´) ìˆ¨ê¹€
                if (clubId !== 'null' && clubId > 0) {
                    card.style.display = 'none';
                }
            });
        }

        // í˜ì´ì§€ë„¤ì´ì…˜ ì´ˆê¸°í™” í•¨ìˆ˜
        function initializePagination() {
            // ëª¨ë“  í˜ì´ì§€ ì•„ì´í…œ ì œê±° (ì´ì „/ë‹¤ìŒ ë²„íŠ¼ ì œì™¸)
            const pageItems = paginationElement.querySelectorAll('.page-item:not(#prev-page):not(#next-page)');
            pageItems.forEach(item => item.remove());

            // í•„í„°ë§ëœ ì¹´ë“œ ê¸°ì¤€ìœ¼ë¡œ ì´ í˜ì´ì§€ ìˆ˜ ê³„ì‚°
            const totalPages = Math.ceil(filteredCards.length / itemsPerPage);

            // í˜ì´ì§€ê°€ ì—†ìœ¼ë©´ í˜ì´ì§€ë„¤ì´ì…˜ ìˆ¨ê¹€
            if (totalPages === 0) {
                paginationContainer.style.display = 'none';
                return;
            } else {
                paginationContainer.style.display = 'flex';
            }

            // í˜ì´ì§€ ë²ˆí˜¸ ìƒì„±
            for (let i = 1; i <= totalPages; i++) {
                const pageItem = document.createElement('li');
                pageItem.className = 'page-item';
                pageItem.dataset.page = i;
                if (i === currentPage) {
                    pageItem.classList.add('active');
                }

                const pageLink = document.createElement('a');
                pageLink.className = 'page-link';
                pageLink.href = '#';
                pageLink.textContent = i;
                pageLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    goToPage(i);
                });

                pageItem.appendChild(pageLink);
                // ë‹¤ìŒ ë²„íŠ¼ ì•ì— ë„£ì–´ ì˜¤ë¥¸ìª½ìœ¼ë¡œ ìˆœì°¨ì ìœ¼ë¡œ ëŠ˜ì–´ë‚˜ë„ë¡ í•¨
                nextPageBtn.before(pageItem);
            }

            // ì´ì „/ë‹¤ìŒ ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ì„¤ì •
            prevPageBtn.classList.toggle('disabled', currentPage === 1);
            nextPageBtn.classList.toggle('disabled', currentPage === totalPages || totalPages === 0);

            // ì´ì „/ë‹¤ìŒ ë²„íŠ¼ ì´ë²¤íŠ¸
            prevPageBtn.querySelector('.page-link').addEventListener('click', function(e) {
                e.preventDefault();
                if (currentPage > 1) {
                    goToPage(currentPage - 1);
                }
            });

            nextPageBtn.querySelector('.page-link').addEventListener('click', function(e) {
                e.preventDefault();
                if (currentPage < totalPages) {
                    goToPage(currentPage + 1);
                }
            });
        }

        // íŠ¹ì • í˜ì´ì§€ë¡œ ì´ë™í•˜ëŠ” í•¨ìˆ˜
        function goToPage(page) {
            currentPage = page;

            // í™œì„± í˜ì´ì§€ í‘œì‹œ ì—…ë°ì´íŠ¸
            const pageItems = paginationElement.querySelectorAll('.page-item');
            pageItems.forEach(item => {
                if (item.dataset.page == page) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });

            // ì´ì „/ë‹¤ìŒ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            const totalPages = Math.ceil(filteredCards.length / itemsPerPage);
            prevPageBtn.classList.toggle('disabled', currentPage === 1);
            nextPageBtn.classList.toggle('disabled', currentPage === totalPages);

            // ì¹´ë“œ í‘œì‹œ ì—…ë°ì´íŠ¸
            displayCards();
        }

        // ì¹´ë“œ í‘œì‹œ í•¨ìˆ˜
        function displayCards() {
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;

            // ëª¨ë“  ì¹´ë“œ ìˆ¨ê¹€
            reservationCards.forEach(card => {
                card.style.display = 'none';
            });

            // í˜„ì¬ í˜ì´ì§€ì— í•´ë‹¹í•˜ëŠ” ì¹´ë“œë§Œ í‘œì‹œ (í´ëŸ½ IDê°€ ìˆëŠ” ì˜ˆì•½ì€ ì œì™¸)
            for (let i = startIndex; i < endIndex && i < filteredCards.length; i++) {
                const clubId = filteredCards[i].getAttribute('data-club-id');
                // í´ëŸ½ IDê°€ nullì´ ì•„ë‹ˆê³  0ë³´ë‹¤ í¬ë©´ ê³„ì† ìˆ¨ê¹€ ìƒíƒœ ìœ ì§€
                if (clubId === 'null' || clubId <= 0) {
                    filteredCards[i].style.display = 'block';
                }
            }
        }

        // í•„í„°ì™€ ê²€ìƒ‰ ì ìš© í•¨ìˆ˜
        function applyFilters() {
            const statusValue = statusFilter.value;
            const searchValue = searchBox.value.toLowerCase();

            // í•„í„°ë§ëœ ì¹´ë“œ ë°°ì—´ ì´ˆê¸°í™”
            filteredCards = [];

            // ëª¨ë“  ì¹´ë“œì— í•„í„° ì ìš©
            reservationCards.forEach(card => {
                // í´ëŸ½ ì˜ˆì•½ í•„í„°ë§ - í´ëŸ½ IDê°€ ìˆëŠ” ì˜ˆì•½ì€ ì œì™¸
                const clubId = card.getAttribute('data-club-id');
                if (clubId !== 'null' && clubId > 0) {
                    return; // í´ëŸ½ ì˜ˆì•½ì€ ê±´ë„ˆëœ€
                }

                // ìƒíƒœ í•„í„°ë§ (í´ë˜ìŠ¤ ëŒ€ì‹  í…ìŠ¤íŠ¸ ë‚´ìš©ìœ¼ë¡œ í™•ì¸)
                const statusSpan = card.querySelector('.status-badge');
                const cardStatus = statusSpan ? statusSpan.textContent.trim() : '';

                const statusMatch = statusValue === 'all' ||
                    (statusValue === 'PENDING' && cardStatus === 'ëŒ€ê¸°ì¤‘') ||
                    (statusValue === 'CONFIRMED' && cardStatus === 'ì˜ˆì•½ì™„ë£Œ') ||
                    (statusValue === 'CANCELLED' && cardStatus === 'ì·¨ì†Œë¨') ||
                    (statusValue === 'COMPLETED' && cardStatus === 'ì™„ë£Œë¨');


                // ê²€ìƒ‰ì–´ í•„í„°ë§
                const cardTitle = card.querySelector('.reservation-title').textContent.toLowerCase();
                const searchMatch = cardTitle.includes(searchValue);

                // í•„í„° ì ìš©í•˜ì—¬ ë°°ì—´ì— ì¶”ê°€
                if (statusMatch && searchMatch) {
                    filteredCards.push(card);
                }
            });

            // í•„í„°ë§ í›„ í˜ì´ì§€ë„¤ì´ì…˜ ì´ˆê¸°í™” ë° ì²« í˜ì´ì§€ í‘œì‹œ
            currentPage = 1;
            initializePagination();
            displayCards();

            // í•„í„° ì ìš© í›„ ë³´ì´ëŠ” ì¹´ë“œê°€ ì—†ìœ¼ë©´ ë©”ì‹œì§€ í‘œì‹œ
            checkNoVisibleCards();
        }

        // ì •ë ¬ ê¸°ëŠ¥
        function applySorting() {
            const sortValue = sortFilter.value;
            const container = document.querySelector('.reservations-grid');
            const cards = Array.from(reservationCards).filter(card => {
                // í´ëŸ½ ì˜ˆì•½ í•„í„°ë§
                const clubId = card.getAttribute('data-club-id');
                return clubId === 'null' || clubId <= 0; // í´ëŸ½ ì˜ˆì•½ì´ ì•„ë‹Œ ì¹´ë“œë§Œ ì •ë ¬
            });

            cards.sort((a, b) => {
                if (sortValue === 'date_desc' || sortValue === 'date_asc') {
                    const dateA = new Date(a.querySelectorAll('.detail-value')[0].textContent.trim().replace(/[ë…„ì›”ì¼]/g, ''));
                    const dateB = new Date(b.querySelectorAll('.detail-value')[0].textContent.trim().replace(/[ë…„ì›”ì¼]/g, ''));

                    return sortValue === 'date_asc' ? dateA - dateB : dateB - dateA;
                } else if (sortValue === 'price_desc' || sortValue === 'price_asc') {
                    const priceA = parseInt(a.querySelectorAll('.detail-value')[2].textContent.replace(/[^0-9]/g, ''));
                    const priceB = parseInt(b.querySelectorAll('.detail-value')[2].textContent.replace(/[^0-9]/g, ''));

                    return sortValue === 'price_asc' ? priceA - priceB : priceB - priceA;
                }

                return 0;
            });

            // ì •ë ¬ëœ ì¹´ë“œë¥¼ ë‹¤ì‹œ ì»¨í…Œì´ë„ˆì— ì¶”ê°€
            cards.forEach(card => container.appendChild(card));

            // ì •ë ¬ í›„ í•„í„° ë‹¤ì‹œ ì ìš©
            applyFilters();
        }

        // ë³´ì´ëŠ” ì¹´ë“œê°€ ì—†ëŠ”ì§€ í™•ì¸í•˜ê³  ë©”ì‹œì§€ í‘œì‹œ
        function checkNoVisibleCards() {
            const grid = document.querySelector('.reservations-grid');
            // ê°œì¸ ì˜ˆì•½ë§Œ ì¹´ìš´íŠ¸
            const personalReservations = Array.from(reservationCards).filter(card => {
                const clubId = card.getAttribute('data-club-id');
                return clubId === 'null' || clubId <= 0;
            });

            if (filteredCards.length === 0 && personalReservations.length > 0) {
                // ë™ì ìœ¼ë¡œ "í•„í„°ë§ëœ ê²°ê³¼ ì—†ìŒ" ë©”ì‹œì§€ ìƒì„±
                let noResults = document.querySelector('.no-filtered-results');

                if (!noResults) {
                    noResults = document.createElement('div');
                    noResults.className = 'no-reservations no-filtered-results';
                    noResults.innerHTML = `
                  <i class="fas fa-filter"></i>
                  <h3>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
                  <p>ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë‚˜ í•„í„° ì¡°ê±´ì„ ì‚¬ìš©í•´ë³´ì„¸ìš”.</p>
                `;
                    grid.after(noResults);
                } else {
                    noResults.style.display = 'block';
                }

                grid.style.display = 'none';
            } else if (personalReservations.length === 0) {
                // ê°œì¸ ì˜ˆì•½ì´ ì•„ì˜ˆ ì—†ëŠ” ê²½ìš°
                let noPersonalReservations = document.querySelector('.no-personal-reservations');

                if (!noPersonalReservations) {
                    noPersonalReservations = document.createElement('div');
                    noPersonalReservations.className = 'no-reservations no-personal-reservations';
                    noPersonalReservations.innerHTML = `
                  <i class="fas fa-calendar-times"></i>
                  <h3>ê°œì¸ ì˜ˆì•½ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</h3>
                  <p>ìƒˆë¡œìš´ ì˜ˆì•½ì„ ë“±ë¡í•˜ì‹œë©´ ì´ê³³ì—ì„œ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                `;
                    grid.after(noPersonalReservations);
                } else {
                    noPersonalReservations.style.display = 'block';
                }

                grid.style.display = 'none';
            } else {
                grid.style.display = 'grid';
                const noResults = document.querySelector('.no-filtered-results');
                if (noResults) {
                    noResults.style.display = 'none';
                }
                const noPersonalReservations = document.querySelector('.no-personal-reservations');
                if (noPersonalReservations) {
                    noPersonalReservations.style.display = 'none';
                }
            }
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        statusFilter.addEventListener('change', function() {
            applyFilters();
        });

        sortFilter.addEventListener('change', function() {
            applySorting();
        });

        searchBox.addEventListener('input', function() {
            applyFilters();
        });

        // ì´ˆê¸° ì‹¤í–‰
        if (reservationCards.length > 0) {
            // ë‚ ì§œê°€ ì§€ë‚œ ì˜ˆì•½ì„ 'ì™„ë£Œë¨'ìœ¼ë¡œ ì—…ë°ì´íŠ¸
            updateCompletedReservations();

            // 1ë¶„ë§ˆë‹¤ ìƒíƒœ ì—…ë°ì´íŠ¸ (ì„ íƒì )
            setInterval(updateCompletedReservations, 60000);

            // í´ëŸ½ ì˜ˆì•½ ìˆ¨ê¸°ê¸°
            hideClubReservations();
            applySorting();
            applyFilters();
        }
    });

    // ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜
    function openCancelModal(reservationId) {
        document.getElementById('reservationIdToCancel').value = reservationId;
        document.getElementById('cancelModal').style.display = 'flex';
    }

    function closeCancelModal() {
        document.getElementById('cancelModal').style.display = 'none';
    }

    // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
    window.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeCancelModal();
        }
    });

    // ëª¨ë‹¬ ë°”ê¹¥ í´ë¦­ ì‹œ ë‹«ê¸°
    window.onclick = function(event) {
        const modal = document.getElementById('cancelModal');
        if (event.target === modal) {
            closeCancelModal();
        }
    };

    // í˜ì´ì§€ê°€ ë¡œë“œë  ë•Œ ì‹¤í–‰
    window.onload = function() {
        // ë¸Œë¼ìš°ì € íˆìŠ¤í† ë¦¬ ì¡°ì‘
        history.pushState(null, null, location.href);

        // ë’¤ë¡œê°€ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ ê°ì§€ (popstate)
        window.onpopstate = function() {
            history.go(1); // ê°•ì œë¡œ ì•ìœ¼ë¡œ ì´ë™
        };
    };

    // í˜ì´ì§€ë¥¼ ë– ë‚  ë•Œ ê²½ê³  ë©”ì‹œì§€ í‘œì‹œ (ì„ íƒì )
    window.addEventListener('beforeunload', function(e) {
        // ì·¨ì†Œ ë©”ì‹œì§€
        const message = 'í˜ì´ì§€ë¥¼ ë– ë‚˜ì‹œê² ìŠµë‹ˆê¹Œ?';
        e.returnValue = message;
        return message;
    });
</script>
</body>
</html>