<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>카테고리 페이지</title>
  <link rel="stylesheet" th:href="@{/css/bottom.css}">
  <link rel="stylesheet" th:href="@{/css/category.css}">
  <link rel="stylesheet" th:href="@{/css/top.css}">
  <!-- 수정된 스타일 코드 -->
  <style>
    /* 서브 카테고리 iframe 컨테이너 */
    .iframe-container {
      display: none; /* 처음에는 숨김 상태 */
      position: absolute;
      top: 150px; /* 세부 카테고리 아래에 위치하도록 상단 여백 조정 */
      left: 0;
      width: 100%;
      height: auto; /* 자동 높이로 변경 */
      min-height: calc(100% - 150px); /* 최소 높이 설정 */
      background-color: white;
      z-index: 10;
      border-radius: 8px;
      overflow: visible; /* 스크롤 제거를 위해 visible로 변경 */
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    /* iframe 스타일 */
    .club-detail-iframe {
      width: 100%;
      height: 800px; /* 충분한 고정 높이 설정 */
      border: none;
      border-radius: 8px;
      overflow: visible; /* 스크롤 제거 */
    }

    /* iframe 내 스크롤바 제거 */
    .club-detail-iframe::-webkit-scrollbar {
      display: none; /* 웹킷 브라우저용 */
    }

    .club-detail-iframe {
      scrollbar-width: none; /* Firefox용 */
      -ms-overflow-style: none; /* IE 및 Edge용 */
    }

    /* 뒤로가기 버튼 스타일 */
    .iframe-back-button {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 20;
      background-color: rgba(255, 255, 255, 0.9);
      padding: 8px 16px;
      border-radius: 4px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      cursor: pointer;
      border: none;
      display: flex;
      align-items: center;
      font-size: 14px;
      font-weight: 500;
    }

    .iframe-back-button:hover {
      background-color: rgba(240, 240, 240, 0.9);
    }

    /* 세부 카테고리 헤더 스타일 */
    .category-header {
      background-color: white;
      padding: 20px;
      border-radius: 8px 8px 0 0;
      margin-bottom: 0;
      border-bottom: 1px solid #eee;
    }

    /* 서브카테고리 위치 상대값으로 설정 */
    .sub-categories {
      position: relative;
    }

    /* 동호회 목록 컨테이너를 숨기는 클래스 */
    .hide-clubs-list {
      display: none;
    }
  </style>
</head>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // 클럽 아이템에 이벤트 리스너 추가
    document.querySelectorAll('.club-item').forEach(item => {
      item.addEventListener('click', function(e) {
        e.preventDefault();
        const clubLink = this.querySelector('.club-link');
        const clubId = clubLink.href.split('club_id=')[1];
        const clubUrl = clubLink.href;

        showClubDetailInIframe(clubUrl, clubId);
      });
    });

    // iframe을 사용해 클럽 상세 표시
    function showClubDetailInIframe(url, clubId) {
      const subCatDiv = document.querySelector('.sub-categories');

      // 동호회 목록 숨기기
      const clubsList = document.querySelector('.clubs-title');
      const clubsListItems = document.querySelector('.clubs-list') || document.querySelector('.no-clubs');

      if (clubsList) clubsList.classList.add('hide-clubs-list');
      if (clubsListItems) clubsListItems.classList.add('hide-clubs-list');

      // 이미 존재하는 iframe 컨테이너가 있는지 확인
      let container = document.querySelector('.iframe-container');

      // 없으면 새로 생성
      if (!container) {
        container = document.createElement('div');
        container.className = 'iframe-container';

        // 뒤로가기 버튼 생성
        const backButton = document.createElement('button');
        backButton.className = 'iframe-back-button';
        backButton.innerHTML = '← 목록으로 돌아가기';
        backButton.onclick = function() {
          hideIframe();
          // 브라우저 히스토리 업데이트
          history.pushState(null, '', '/category/category_info');
        };

        // iframe 생성
        const iframe = document.createElement('iframe');
        iframe.className = 'club-detail-iframe';

        // iframe 로드 이벤트 추가
        iframe.onload = function() {
          try {
            // iframe 내부 문서의 높이에 맞게 조절 시도
            adjustIframeHeight(iframe);

            // 필요하다면 주기적으로 높이 체크
            setInterval(function() {
              adjustIframeHeight(iframe);
            }, 1000);
          } catch (e) {
            console.error('iframe 높이 조절 실패:', e);
          }
        };

        // 컨테이너에 추가
        container.appendChild(backButton);
        container.appendChild(iframe);
        subCatDiv.appendChild(container);
      }

      // iframe 참조 가져오기
      const iframe = container.querySelector('.club-detail-iframe');

      // iframe src 설정 및 표시
      iframe.src = url;
      container.style.display = 'block';

      // 브라우저 히스토리 업데이트
      history.pushState({view: 'club_detail', clubId: clubId}, '', url);

      // 브라우저 뒤로가기 이벤트 처리
      window.addEventListener('popstate', function(e) {
        if (!e.state || e.state.view !== 'club_detail') {
          hideIframe();
        }
      });
    }

    // iframe 높이 자동 조절 함수
    function adjustIframeHeight(iframe) {
      try {
        // iframe의 내부 문서에 접근
        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;

        // 내부 문서의 높이 계산
        const height = iframeDoc.body.scrollHeight;

        // iframe 높이 설정
        iframe.style.height = height + 'px';

        // 컨테이너 높이도 함께 조절
        const container = document.querySelector('.iframe-container');
        if (container) {
          container.style.height = 'auto';
        }
      } catch (e) {
        console.error('iframe 높이 조절 실패:', e);
      }
    }

    // iframe 숨기기
    function hideIframe() {
      const container = document.querySelector('.iframe-container');
      if (container) {
        container.style.display = 'none';

        // 동호회 목록 다시 표시
        const clubsList = document.querySelector('.clubs-title');
        const clubsListItems = document.querySelector('.clubs-list') || document.querySelector('.no-clubs');

        if (clubsList) clubsList.classList.remove('hide-clubs-list');
        if (clubsListItems) clubsListItems.classList.remove('hide-clubs-list');
      }
    }
  });
</script>

<body th:style="|background-image: url('@{/sources/picture/우주배경.png}');
background-size: cover;
background-repeat: no-repeat;
background-position: center;
background-attachment: fixed;|">
<!-- 상단 메뉴 include -->
<div th:replace="~{include/top_search :: top_search}"></div>

<!-- 카테고리 컨테이너 -->
<div class="category-container">
  <!-- 메인 카테고리 -->
  <div class="main-categories">
    <h3 class="category-title">카테고리</h3>
    <ul class="category-list">
      <li class="category-item" th:classappend="${param.category_type == null || param.category_type == 'all' ? 'active' : ''}">
        <a th:href="@{/category/category_info(category_type='all')}">
          <img th:src="@{/sources/picture/전체보기.png}" alt="전체보기 아이콘" class="category-icon">
          전체보기
        </a>
      </li>
      <li th:each="category : ${categoryList}"
          class="category-item"
          th:classappend="${category.category_type == param.category_type ? 'active' : ''}">
        <a th:href="@{/category/category_info(category_type=${category.category_type})}">
          <img th:src="@{/sources/picture/{categoryType}.png(categoryType=${category.category_type})}"
               alt="카테고리 아이콘"
               class="category-icon">
          <span th:text="${category.category_type}"></span>
        </a>
      </li>
    </ul>
    <!-- 클럽 생성하기 버튼 -->
    <a th:href="@{/club/create}" class="create-club-button">
      <i class="fas fa-plus"></i> 클럽 생성하기
    </a>
  </div>

  <!-- 서브 카테고리 -->
  <div class="sub-categories">
    <h3 class="category-title">세부 카테고리</h3>
    <ul class="sub-category-list">
      <li class="sub-category-item" th:classappend="${param.sub_category == null || param.sub_category == 'all' ? 'active' : ''}">
        <a th:href="@{/category/category_info(category_type=${param.category_type ?: 'all'}, sub_category='all')}">전체보기</a>
      </li>
      <li th:if="${list != null}" th:each="subCategory : ${list}"
          class="sub-category-item"
          th:classappend="${subCategory.category_name == param.sub_category ? 'active' : ''}">
        <a th:href="@{/category/category_info(category_type=${param.category_type ?: 'all'}, sub_category=${subCategory.category_name})}"
           th:text="${subCategory.category_name}"></a>
      </li>
    </ul>
    <!-- 동호회 목록 컨테이너 -->

      <h3 class="clubs-title" style="margin-top: 20px;">등록된 동호회</h3>

      <div th:if="${clublist == null || clublist.isEmpty()}" class="no-clubs" style="display: block;">
        등록된 동호회가 없습니다.
      </div>

      <ul th:if="${clublist != null && !clublist.isEmpty()}" class="clubs-list">
        <li th:each="club : ${clublist}" class="club-item" th:attr="data-category=${club.club_category}">
          <a th:href="@{/club/club_info(club_id=${club.club_id})}" class="club-link">

            <!-- ✅ 프로필 이미지 추가 -->
            <div class="club-profile-box">
              <img th:if="${club.club_profile != null}"
                   th:src="@{/image/clubprofile/{img}(img=${club.club_profile})}"
                   alt="클럽 대표 이미지"
                   class="club-profile-image">

              <img th:unless="${club.club_profile != null}"
                   th:src="@{/sources/picture/기본이미지.png}"
                   alt="기본 이미지"
                   class="club-profile-image">
            </div>
            <!-- ✅ 클럽 정보 (한 줄 정렬) -->
            <div class="club-info">
              <div class="club-name" th:text="${club.club_name}"></div>
              <div class="club-category" th:text="'카테고리: ' + ${club.club_category}"></div>
            </div>
          </a>
        </li>
      </ul>
  </div>
</div>


<!-- 하단 정보바 -->
<div th:replace="~{include/bottom_info :: bottom_info}"></div>
<script th:src="@{/js/top.js}"></script>

<!-- AJAX 스크립트 추가 -->
<!-- Font Awesome for icons (You can add this if you want the plus icon) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</body>
</html>