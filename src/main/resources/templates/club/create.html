<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>클럽 생성하기</title>
  <link rel="stylesheet" th:href="@{/css/bottom.css}">
  <link rel="stylesheet" th:href="@{/css/top.css}">
  <link rel="stylesheet" th:href="@{/css/create.css}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <style>
    /* 최소 나이 제한 메뉴바 스타일 */
    .age-slider-container {
      display: flex;
      align-items: center;
      gap: 10px;
      width: 100%;
    }

    .age-value {
      min-width: 80px;
      font-weight: bold;
      color: #4a90e2;
    }

    /* 년도 선택 드롭다운 스타일 */
    .age-select {
      padding: 6px 10px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 14px;
      background-color: #f8f8f8;
      color: #333;
      width: 120px;
      cursor: pointer;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      transition: all 0.2s ease;
    }

    .age-select:hover {
      border-color: #4a90e2;
    }

    .age-select:focus {
      outline: none;
      border-color: #4a90e2;
      box-shadow: 0 0 0 2px rgba(74,144,226,0.2);
    }
  </style>
</head>
<body>
<!-- 상단 메뉴 include -->
<div th:replace="~{include/top_search :: top_search}"></div>

<div class="create-club-container">
  <form th:action="@{/club/create_pro}" method="post" th:object="${clubBean}" class="create-club-form" enctype="multipart/form-data">
    <h2 class="form-title">새 동호회 생성하기</h2>

    <div class="form-group">
      <label for="club_name" class="form-label">동호회 이름 *</label>
      <input type="text" id="club_name" name="club_name" th:field="*{club_name}" class="form-input" required minlength="2" maxlength="40">
      <small class="error-message" th:if="${#fields.hasErrors('club_name')}" th:errors="*{club_name}"></small>
    </div>

    <!-- 최소 나이 제한 - 출생년도 선택 -->
    <div class="form-group">
      <label for="club_agemin" class="form-label">최소 나이 제한 (출생년도)</label>
      <div class="age-slider-container">
        <select id="birth_year" name="birth_year" class="age-select" onchange="updateAgeFromYear(this.value)">
          <option value="0">제한 없음</option>
          <!-- 현재 년도부터 100년 전까지의 옵션 -->
        </select>
        <input type="hidden" id="club_agemin" name="club_agemin" th:field="*{club_agemin}" value="0">
        <span class="age-value">만 <span id="age-value">0</span>세 이상</span>
      </div>
    </div>

    <div class="form-group">
      <label for="club_info" class="form-label">동호회 소개</label>
      <textarea id="club_info" name="club_info" th:field="*{club_info}" class="form-textarea" placeholder="동호회에 대한 설명을 입력해주세요."></textarea>
    </div>

    <div class="form-group">
      <label class="form-label">카테고리 선택 *</label>
      <div class="category-selection">
        <div class="category-column">
          <label for="category_type" class="form-label">대분류</label>
          <select id="category_type" name="category_type" class="form-select" onchange="getSubCategories()">
            <option value="">대분류 선택</option>
            <option th:each="type : ${categoryType}" th:value="${type}" th:text="${type}"></option>
          </select>
          <div id="main-category-loading" class="loading">불러오는 중...</div>
        </div>

        <div class="category-column">
          <label for="club_category" class="form-label">소분류</label>
          <select id="club_category" name="club_category" th:field="*{club_category}" class="form-select" required>
            <option value="">소분류 선택</option>
            <option th:each="category : ${subCategoryList}" th:value="${category.category_name}" th:text="${category.getCategory_name()}"></option>
          </select>
          <div id="sub-category-loading" class="loading">불러오는 중...</div>
          <small class="error-message" th:if="${#fields.hasErrors('club_category')}" th:errors="*{club_category}"></small>
        </div>
      </div>
    </div>

    <input type="hidden" name="club_public" value="WAIT">

    <!-- ✅ 동호회 대표 이미지 업로드 -->
    <div class="form-group">
      <label class="form-label">대표 이미지 업로드</label>
      <input type="file" id="clubImageUpload" name="clubImage" accept="image/*" class="input-file">
      <p id="fileWarning" style="color: red; display: none;">※ 5MB 이하의 이미지만 업로드 가능합니다.</p>

      <!-- ✅ 기본 이미지 미리보기 -->
      <div id="imagePreviewContainer" class="preview-container">
        <img id="profilePreview" th:src="@{/sources/picture/기본이미지.png}" alt="대표 이미지 미리보기" style="max-width: 200px; margin-top: 10px;">
      </div>
    </div>

    <div class="form-actions">
      <button type="submit" class="btn btn-primary">동호회 생성하기</button>
      <a th:href="@{/category/category_info}" class="btn btn-secondary">취소</a>
    </div>
  </form>
</div>

<!-- 하단 정보바 -->
<div th:replace="~{include/bottom_info :: bottom_info}"></div>

<script th:src="@{/js/top.js}"></script>
<script>
  // 대분류 선택 시 소분류 가져오기 함수
  function getSubCategories() {
    const categoryType = document.getElementById("category_type").value;
    const subCategorySelect = document.getElementById("club_category");
    const loadingIndicator = document.getElementById("sub-category-loading");

    if (!categoryType) {
      // 대분류가 선택되지 않았을 경우 소분류 초기화
      while (subCategorySelect.options.length > 1) {
        subCategorySelect.remove(1);
      }
      return;
    }

    // 로딩 표시 보이기
    loadingIndicator.style.display = "block";

    // AJAX 요청
    const xhr = new XMLHttpRequest();
    xhr.open("GET", "/club/get_sub_categories?category_type=" + encodeURIComponent(categoryType), true);

    xhr.onload = function() {
      // 로딩 표시 숨기기
      loadingIndicator.style.display = "none";

      if (xhr.status === 200) {
        const categories = JSON.parse(xhr.responseText);

        // 기존 옵션 초기화 (첫 번째 옵션 제외)
        while (subCategorySelect.options.length > 1) {
          subCategorySelect.remove(1);
        }

        // 새 옵션 추가
        categories.forEach(function(category) {
          const option = document.createElement("option");
          option.value = category.category_name;
          option.text = category.category_name;
          subCategorySelect.add(option);
        });
      } else {
        console.error("카테고리 가져오기 실패: " + xhr.status);
      }
    };

    xhr.onerror = function() {
      // 로딩 표시 숨기기
      loadingIndicator.style.display = "none";
      console.error("카테고리 가져오기 오류 발생");
    };

    xhr.send();
  }

  // 출생년도로부터 나이 계산하여 업데이트하는 함수
  function updateAgeFromYear(birthYear) {
    const currentYear = new Date().getFullYear();
    let age = 0;

    if (birthYear > 0) {
      age = currentYear - birthYear;
    }

    document.getElementById('age-value').textContent = age;
    document.getElementById('club_agemin').value = age;
  }

  // 이미지 미리보기 기능
  document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('clubImageUpload').addEventListener('change', function(event) {
      const preview = document.getElementById('profilePreview');
      const file = event.target.files[0];
      const fileWarning = document.getElementById('fileWarning');

      if (file) {
        if (file.size > 5 * 1024 * 1024) {
          fileWarning.style.display = "block";
          return;
        } else {
          fileWarning.style.display = "none";
        }

        const reader = new FileReader();
        reader.onload = function(e) {
          preview.src = e.target.result;
          preview.style.display = "block";
        };
        reader.readAsDataURL(file);
      }
    });

    // 페이지 로드 시 년도 옵션 생성 및 초기값 설정
    const birthYearSelect = document.getElementById('birth_year');
    const currentYear = new Date().getFullYear();

    // 년도 옵션 생성 (현재 년도부터 100년 전까지)
    for (let year = currentYear; year >= currentYear - 100; year--) {
      const option = document.createElement('option');
      option.value = year;
      option.textContent = year + '년';
      birthYearSelect.appendChild(option);
    }

    // 초기값 설정
    const clubAgeMin = document.getElementById('club_agemin').value;
    if (clubAgeMin > 0) {
      const birthYear = currentYear - clubAgeMin;
      birthYearSelect.value = birthYear;
      updateAgeFromYear(birthYear);
    }
  });
</script>
</body>
</html>